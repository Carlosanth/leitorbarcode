<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor de Código de Barras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 10px;
      text-align: center;
    }

    h2 {
      margin-bottom: 10px;
    }

    #scanner-container {
      width: 100%;
      max-width: 100%;
      height: 320px;
      margin: auto;
      border-radius: 10px;
      overflow: hidden;
      background-color: black;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #zoomControl {
      margin: 15px auto;
      width: 90%;
      max-width: 400px;
    }

    #output {
      margin: 10px auto;
      padding: 10px;
      background: #fff;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }

    button, input[type=range] {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background: #3498db;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #2c80b4;
    }

    input[type=range] {
      width: 100%;
    }

    @media (max-width: 600px) {
      #output {
        width: 95%;
      }

      button, input[type=range] {
        width: 90%;
      }
    }
  </style>
</head>
<body>

  <h2>📷 Leitor de Código de Barras</h2>

  <button id="startButton">▶️ Iniciar Leitura</button>

  <div id="scanner-container" style="display:none">
    <video id="video" autoplay></video>
  </div>

  <div id="zoomControl" style="display:none">
    <label for="zoomRange">Zoom: <span id="zoomValue">2.0</span>x</label><br>
    <input type="range" id="zoomRange" min="1" max="3" step="0.1" value="2">
  </div>

  <button onclick="downloadCSV()">📥 Baixar CSV</button>

  <div id="output">
    <h3>Códigos Lidos:</h3>
  </div>

  <audio id="beep-sound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

  <script>
    const codeReader = new ZXing.BrowserBarcodeReader();
    const videoElement = document.getElementById('video');
    const outputElement = document.getElementById('output');
    const zoomRange = document.getElementById('zoomRange');
    const zoomValue = document.getElementById('zoomValue');
    const beep = document.getElementById('beep-sound');
    const scannedCodesList = [];

    let track = null;

    document.getElementById('startButton').addEventListener('click', () => {
      document.getElementById('scanner-container').style.display = 'block';
      document.getElementById('zoomControl').style.display = 'block';
      document.getElementById('startButton').style.display = 'none';
      startScanner();
    });

    async function startScanner() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        videoElement.srcObject = stream;

        track = stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();

        if (capabilities.zoom) {
          zoomRange.min = capabilities.zoom.min;
          zoomRange.max = capabilities.zoom.max;
          zoomRange.step = capabilities.zoom.step || 0.1;
          zoomRange.value = 2;
          applyZoom(2);
        }

        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
          if (result) {
            const code = result.getText();
            beep.currentTime = 0;
            beep.play();

            scannedCodesList.push(code);
            const p = document.createElement('p');
            const count = scannedCodesList.length;
            const number = (count < 10 ? '0' : '') + count;
            p.textContent = `${number} - ${code}`;
            outputElement.appendChild(p);
            outputElement.scrollTop = outputElement.scrollHeight;
          }
        });

      } catch (err) {
        alert("Erro ao acessar câmera: " + err);
      }
    }

    function applyZoom(zoom) {
      if (track) {
        const constraints = { advanced: [{ zoom }] };
        track.applyConstraints({ advanced: constraints.advanced }).catch(e => {
          console.warn("Zoom não suportado:", e);
        });
      }
    }

    zoomRange.addEventListener('input', () => {
      const zoom = Number(zoomRange.value);
      zoomValue.textContent = zoom.toFixed(1);
      applyZoom(zoom);
    });

    function downloadCSV() {
      let csv = "Nº,Código de Barras\n";
      scannedCodesList.forEach((code, index) => {
        const number = (index + 1 < 10 ? '0' : '') + (index + 1);
        csv += `${number},${code}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "codigos_lidos.csv";
      a.click();
    }
  </script>

</body>
</html>
